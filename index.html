<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Typing Study â€” Minimal Prototype</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; max-width: 720px; margin: 24px auto; line-height: 1.45; }
    h1 { font-size: 1.25rem; margin-bottom: 0.25rem; }
    .muted { color: #666; font-size: 0.9rem; margin-top: 0; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin: 16px 0; }
    .hidden { display: none; }
    textarea { width: 100%; min-height: 120px; font-size: 1rem; }
    button { padding: 10px 14px; border-radius: 8px; border: 1px solid #ccc; background: #f7f7f7; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row > * { flex: 1; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <h1>Typing Study â€” Minimal Prototype</h1>
  <p class="muted">One page, one sentence. Weâ€™ll expand after verifying the full flow.</p>

  <!-- Section 1: Consent + Start -->
  <section id="s-consent" class="card">
    <h2>Consent</h2>
    <p>This prototype records timing for a single sentence. No personal info is collected.</p>
    <label><input id="agree" type="checkbox" /> I am 18â€“22 or 40â€“55 and I consent.</label>
    <div class="row" style="margin-top: 12px;">
      <select id="ageGroup">
        <option value="">Age groupâ€¦</option>
        <option>18â€“22</option>
        <option>40â€“55</option>
      </select>
      <button id="btnStart" disabled>Start</button>
    </div>
    <p id="startInfo" class="mono"></p>
  </section>

  <!-- Section 1.5: Switch Device -->
  <section id="s-switch" class="card hidden">
    <h2>Start on your other device</h2>
    <p id="switchMsg"></p>
    <p>Open this link on your other device to continue:</p>
    <p class="mono" id="continueLink"></p>
  </section>

  <!-- Section 2: Trial -->
  <section id="s-trial" class="card hidden">
    <h2>Type Exactly What You See</h2>
    <p id="sentence" class="mono"></p>
    <textarea id="input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
              placeholder="Type the sentence here. Press Enter to submit."></textarea>
    <div class="row" style="margin-top: 8px;">
      <button id="btnSubmit" disabled>Submit (Enter)</button>
      <div id="timer" class="mono" style="text-align:right;">0 ms</div>
    </div>
    <p id="help" class="muted">Tip: donâ€™t paste; type it out. Backspace is allowed.</p>
  </section>

  <!-- Section 3: Done -->
  <section id="s-done" class="card hidden">
    <h2>Done âœ…</h2>
    <p>Thanks! Data sent. Your participant ID:</p>
    <p class="mono" id="pidOut"></p>
    <p class="muted">Weâ€™ll extend this to multiple sentences and the phone/laptop flow next.</p>
  </section>

  <script>
    // ðŸ‘‰ CONFIG
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbz5dTthOWO4crOgte-hUWlIDR4bM2LgLshVOdV-BacKt606Ob8B5dKLxLHB2BalhYG0sg/exec";
    const SECRET   = "h33iy43brfu3hf93fhb3fi3ivh3v";

    // Environment + helpers
    const IS_MOBILE = /Mobi|Android/i.test(navigator.userAgent);
    const DEVICE_NOW = IS_MOBILE ? "phone" : "laptop";
    const DEVICE_OTHER = IS_MOBILE ? "laptop" : "phone";
    const makeContinueUrl = (pid) => location.origin + location.pathname + "?pid=" + encodeURIComponent(pid);

    // DOM
    const sConsent = document.getElementById("s-consent");
    const sSwitch  = document.getElementById("s-switch");
    const sTrial   = document.getElementById("s-trial");
    const sDone    = document.getElementById("s-done");
    const agree    = document.getElementById("agree");
    const btnStart = document.getElementById("btnStart");
    const ageGroup = document.getElementById("ageGroup");
    const startInfo= document.getElementById("startInfo");
    const switchMsg= document.getElementById("switchMsg");
    const continueLink = document.getElementById("continueLink");
    const sentence = document.getElementById("sentence");
    const input    = document.getElementById("input");
    const btnSubmit= document.getElementById("btnSubmit");
    const timerEl  = document.getElementById("timer");
    const pidOut   = document.getElementById("pidOut");

    // State
    let pid = null;
    let t0 = 0, lastT = 0, backspaces = 0, paused500 = 0;
    let keystrokes = [];

    // Helpers
    const uuid = () => "TS-" + Math.random().toString(36).slice(2) + Date.now().toString(36);
    const show = (el) => el.classList.remove("hidden");
    const hide = (el) => el.classList.add("hidden");
    const ms = () => performance.now();

    const TEST_SENTENCE = "Machine learning can analyze how fast people type under different conditions.";

    // Enable Start when consent + age chosen
    function updateStartBtn() {
      btnStart.disabled = !(agree.checked && ageGroup.value);
    }
    agree.addEventListener("change", updateStartBtn);
    ageGroup.addEventListener("change", updateStartBtn);

    btnStart.addEventListener("click", async () => {
      // PID from URL (?pid=...) or create new
      const pidFromUrl = new URLSearchParams(location.search).get("pid");
      pid = pidFromUrl || localStorage.getItem("ts_pid") || uuid();
      localStorage.setItem("ts_pid", pid);

      // Randomize device order relative to current device
      const coin = Math.random() < 0.5;
      const deviceOrder = coin ? (DEVICE_NOW + "â†’" + DEVICE_OTHER) : (DEVICE_OTHER + "â†’" + DEVICE_NOW);
      localStorage.setItem("ts_device_order", deviceOrder);

      // Send participant_start
      try {
        await fetch(ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify({
            secret: SECRET,
            type: "participant_start",
            pid,
            age_group: ageGroup.value,
            device_order: deviceOrder,
            consent_version: "v1",
            start_iso: new Date().toISOString()
          })
        });
      } catch(e) { console.warn("participant_start failed", e); }

      startInfo.textContent = `PID: ${pid} â€¢ Assigned order: ${deviceOrder}`;

      // If order starts with other device, show switch message
      const mustSwitch = deviceOrder.startsWith(DEVICE_OTHER);
      if (mustSwitch) {
        hide(sConsent); show(sSwitch);
        const url = makeContinueUrl(pid);
        switchMsg.textContent = `Your assigned order is ${deviceOrder}. Please start on your ${DEVICE_OTHER}.`;
        continueLink.textContent = url;
        continueLink.style.userSelect = "all";
        return;
      }

      // Otherwise continue to trial
      hide(sConsent); show(sTrial);
      setupTrial();
    });

    function setupTrial() {
      sentence.textContent = TEST_SENTENCE;
      input.value = "";
      input.focus();
      keystrokes = [];
      backspaces = 0;
      paused500 = 0;
      t0 = ms();
      lastT = t0;

      // Timer display
      const tick = () => { timerEl.textContent = `${Math.round(ms() - t0)} ms`; if(!sTrial.classList.contains("hidden")) requestAnimationFrame(tick); };
      requestAnimationFrame(tick);

      // Capture keys
      input.addEventListener("keydown", onKeydown);
      input.addEventListener("input", onInput);
      input.addEventListener("paste", e => e.preventDefault());
      input.addEventListener("blur", ()=>{});

      // Enable submit when correct
      input.addEventListener("input", () => { btnSubmit.disabled = (input.value !== TEST_SENTENCE); });
      input.addEventListener("keydown", e => { if(e.key === "Enter"){ e.preventDefault(); if(!btnSubmit.disabled) btnSubmit.click(); } });
      btnSubmit.addEventListener("click", submitTrial, { once: true });
    }

    function onKeydown(e) {
      const t = ms();
      if (t - lastT >= 500) paused500++;
      lastT = t;
      if (e.key === "Backspace") backspaces++;
      keystrokes.push({ t_ms: Math.round(t - t0), type: "keydown", key: e.key });
    }

    function onInput(e) {
      const t = ms();
      if (t - lastT >= 500) paused500++;
      lastT = t;
      keystrokes.push({ t_ms: Math.round(t - t0), type: "input", value_len: input.value.length });
    }

    async function submitTrial() {
      const end = ms();
      const total = Math.round(end - t0);
      const deltas = [];
      for (let i = 1; i < keystrokes.length; i++) deltas.push(keystrokes[i].t_ms - keystrokes[i-1].t_ms);
      const meanInter = deltas.length ? Math.round(deltas.reduce((a,b)=>a+b,0)/deltas.length) : 0;
      const p95Inter = deltas.length ? Math.round(deltas.sort((a,b)=>a-b)[Math.floor(0.95*(deltas.length-1))]) : 0;

      // trial_summary
      const payload = {
        secret: SECRET,
        type: "trial_summary",
        pid,
        trial_id: "T1",
        device: DEVICE_NOW,
        sentence_id: "S1",
        order_in_block: 1,
        start_ms: 0,
        end_ms: total,
        total_ms: total,
        mean_interkey_ms: meanInter,
        p95_interkey_ms: p95Inter,
        pause500_count: paused500,
        backspace_count: backspaces,
        ua: navigator.userAgent,
        os: "unknown",
        browser: "unknown",
        screen_w: window.screen.width,
        screen_h: window.screen.height,
        dpr: window.devicePixelRatio,
        paste_attempted: false,
        focus_blur_count: 0,
        flags: "proto-v1"
      };

      let ok = false;
      try {
        const res = await fetch(ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify(payload)
        }).then(r=>r.json());
        ok = !!res?.ok;
      } catch(e){ console.error(e); }

      // keystrokes_batch
      try {
        await fetch(ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify({ secret: SECRET, type: "keystrokes_batch", pid, trial_id: "T1", events: keystrokes })
        });
      } catch(e){ console.warn("keystrokes_batch failed", e); }

      // participant_end
      try {
        await fetch(ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify({ secret: SECRET, type: "participant_end", pid, end_iso: new Date().toISOString() })
        });
      } catch(e){}

      hide(sTrial); show(sDone);
      pidOut.textContent = pid + (ok ? "" : " (send failed)");
    }
  </script>
</body>
</html>
